From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Santiago Fernandez Madero <safern@microsoft.com>
Date: Tue, 11 Jan 2022 13:55:22 -0800
Subject: [PATCH] [release/6.0] Build all packages when in source-build

Originating PR:  https://github.com/dotnet/runtime/pull/63653
---
 eng/packaging.targets | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/eng/packaging.targets b/eng/packaging.targets
index 6bcf86dc9f2..ee8e95167d9 100644
--- a/eng/packaging.targets
+++ b/eng/packaging.targets
@@ -34,6 +34,10 @@
                                        '$(IsRIDSpecificProject)' != 'true' and
                                        '$(PreReleaseVersionLabel)' == 'servicing' and
                                        '$(GitHubRepositoryName)' != 'runtimelab'">false</GeneratePackageOnBuild>
+    <!-- When in source-build we need to generate all packages when building for all configurations even in servicing. -->
+    <GeneratePackageOnBuild Condition="!$(GeneratePackageOnBuild) and
+                                       '$(BuildAllConfigurations)' == 'true' and
+                                       '$(DotNetBuildFromSource)' == 'true'">true</GeneratePackageOnBuild>
     <!-- Search for the documentation file in the intellisense package and otherwise pick up the generated one. -->
     <LibIntellisenseDocumentationFilePath>$(XmlDocFileRoot)1033\$(AssemblyName).xml</LibIntellisenseDocumentationFilePath>
     <UseIntellisenseDocumentationFile Condition="'$(UseIntellisenseDocumentationFile)' == '' and Exists('$(LibIntellisenseDocumentationFilePath)')">true</UseIntellisenseDocumentationFile>
@@ -279,7 +283,7 @@
   </Target>
 
   <Target Name="ValidateServicingVersionIsPropertlySet"
-          Condition="'$(PreReleaseVersionLabel)' == 'servicing'"
+          Condition="'$(PreReleaseVersionLabel)' == 'servicing' and '$(DotNetBuildFromSource)' != 'true'"
           AfterTargets="GenerateNuspec">
     <Error Condition="'$(ServicingVersion)' == '0'" Text="ServicingVersion is set to 0 and it should be an increment of the patch version from the last released package." />
   </Target>
