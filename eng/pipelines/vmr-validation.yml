### This pipeline validates new changes of the VMR (https://github.com/dotnet/dotnet)
### VMR is cloned and updates are applied locally

parameters:
- name: vmrBranch
  displayName: dotnet/dotnet branch to use
  type: string
  default: $(System.PullRequest.TargetBranch)

trigger: none

pr:
  branches:
    include:
    - main
    - release/8*
    - internal/release/8*

resources:
  repositories:
  - repository: vmr
    type: github
    name: dotnet/dotnet
    endpoint: public

variables:
- template: templates/variables/pool-providers.yml

- name: vmrPath
  value: $(Agent.BuildDirectory)/vmr

- ${{ if eq(variables['System.TeamProject'], 'internal') }}:
  - group: DotNetBot-GitHub
- ${{ else }}:
  - name: BotAccount-dotnet-bot-repo-PAT
    value: N/A

jobs:
- job: Validate
  displayName: Test VMR synchronization
  pool:
    ${{ if eq(variables['System.TeamProject'], 'public') }}:
      name: $(DncEngPublicBuildPool)
      demands: ImageOverride -equals Build.Ubuntu.2004.Amd64.Open
    ${{ else }}:
      name: $(DncEngInternalBuildPool)
      demands: ImageOverride -equals Build.Ubuntu.2004.Amd64

  steps:
  - template: templates/steps/vmr-prepare.yml
    parameters:
      vmrBranch: ${{ parameters.vmrBranch }}

  - template: templates/steps/vmr-pull-updates.yml
    parameters:
      vmrPath: $(vmrPath)
      vmrBranch: ${{ parameters.vmrBranch }}
      targetRef: $(Build.SourceVersion)
      vmrToken: $(BotAccount-dotnet-bot-repo-PAT)
