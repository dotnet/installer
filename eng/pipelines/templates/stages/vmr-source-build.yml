### This pipeline validates incoming changes to the VMR (https://github.com/dotnet/dotnet)
### The build is run during dotnet/installer's PR
### New changes are applied locally in the VMR, then we source-build and test the content

parameters:
  # The following parameters aren't expected to be passed in rather they are used for encapsulation
  # -----------------------------------------------------------------------------------------------
  centOSStream8Container: mcr.microsoft.com/dotnet-buildtools/prereqs:centos-stream8
  centOSStream9Container: mcr.microsoft.com/dotnet-buildtools/prereqs:centos-stream9
  debian11Arm64Container: mcr.microsoft.com/dotnet-buildtools/prereqs:debian-11-arm64v8
  fedora36Container: mcr.microsoft.com/dotnet-buildtools/prereqs:fedora-36
  ubuntu2004Container: mcr.microsoft.com/dotnet-buildtools/prereqs:ubuntu-20.04
  poolInternalAmd64:
    name: NetCore1ESPool-Svc-Internal
    demands: ImageOverride -equals Build.Ubuntu.1804.Amd64
  poolInternalAmd64PR:
    name: NetCore1ESPool-Internal-XL
    demands: ImageOverride -equals Build.Ubuntu.1804.Amd64
  poolInternalArm64:
    name: Docker-Linux-Arm-Internal
  poolPublicAmd64:
    name: NetCore-Public-XL
    demands: ImageOverride -equals Build.Ubuntu.1804.Amd64.Open

stages:
- stage: VMR_Source_Build
  displayName: VMR Source-Build
  dependsOn: Build
  variables:
  - template: /eng/common/templates/variables/pool-providers.yml
  - template: ../variables/vmr-variables.yml
  # - ${{ if ne(variables['System.TeamProject'], 'public') }}:
  #   - group: AzureDevOps-Artifact-Feeds-Pats

  jobs:
  - template: ../jobs/vmr-source-build.yml
    parameters:
      name: CentOSStream8_Online
      architecture: x64
      pool:
        ${{ if eq(variables['System.TeamProject'], 'public') }}:
          ${{ parameters.poolPublicAmd64 }}
        ${{ if eq(variables['System.TeamProject'], 'internal') }}:
          ${{ if in(variables['Build.Reason'], 'PullRequest') }}:
            ${{ parameters.poolInternalAmd64PR }}
          ${{ else }}:
            ${{ parameters.poolInternalAmd64 }}
      bootstrapPrep: false
      container: ${{ parameters.centOSStream8Container }}
      enablePoison: false
      excludeSdkContentTests: true
      excludeOmniSharpTests: true
      runOnline: true
  - ${{ if ne(variables['Build.Reason'], 'PullRequest') }}:
    - template: ../jobs/vmr-source-build.yml
      parameters:
        name: CentOSStream8_Offline
        architecture: x64
        pool:
          ${{ if eq(variables['System.TeamProject'], 'public') }}:
            ${{ parameters.poolPublicAmd64 }}
          ${{ if eq(variables['System.TeamProject'], 'internal') }}:
            ${{ if in(variables['Build.Reason'], 'PullRequest') }}:
              ${{ parameters.poolInternalAmd64PR }}
            ${{ else }}:
              ${{ parameters.poolInternalAmd64 }}
        bootstrapPrep: false
        container: ${{ parameters.centOSStream8Container }}
        enablePoison: false
        excludeSdkContentTests: false
        excludeOmniSharpTests: true
        runOnline: false
    - template: ../jobs/vmr-source-build.yml
      parameters:
        name: CentOSStream9_Offline
        architecture: x64
        pool:
          ${{ if eq(variables['System.TeamProject'], 'public') }}:
            ${{ parameters.poolPublicAmd64 }}
          ${{ if eq(variables['System.TeamProject'], 'internal') }}:
            ${{ if in(variables['Build.Reason'], 'PullRequest') }}:
              ${{ parameters.poolInternalAmd64PR }}
            ${{ else }}:
              ${{ parameters.poolInternalAmd64 }}
        bootstrapPrep: false
        container: ${{ parameters.centOSStream9Container }}
        enablePoison: false
        excludeSdkContentTests: false
        excludeOmniSharpTests: false
        runOnline: false
    - template: ../jobs/vmr-source-build.yml
      parameters:
        name: Fedora36_Offline
        architecture: x64
        pool:
          ${{ if eq(variables['System.TeamProject'], 'public') }}:
            ${{ parameters.poolPublicAmd64 }}
          ${{ if eq(variables['System.TeamProject'], 'internal') }}:
            ${{ if in(variables['Build.Reason'], 'PullRequest') }}:
              ${{ parameters.poolInternalAmd64PR }}
            ${{ else }}:
              ${{ parameters.poolInternalAmd64 }}
        bootstrapPrep: false
        container: ${{ parameters.fedora36Container }}
        enablePoison: true
        excludeSdkContentTests: false
        excludeOmniSharpTests: false
        runOnline: false
    - template: ../jobs/vmr-source-build.yml
      parameters:
        name: Ubuntu2004_Offline
        architecture: x64
        pool:
          ${{ if eq(variables['System.TeamProject'], 'public') }}:
            ${{ parameters.poolPublicAmd64 }}
          ${{ if eq(variables['System.TeamProject'], 'internal') }}:
            ${{ if in(variables['Build.Reason'], 'PullRequest') }}:
              ${{ parameters.poolInternalAmd64PR }}
            ${{ else }}:
              ${{ parameters.poolInternalAmd64 }}
        bootstrapPrep: false
        container: ${{ parameters.ubuntu2004Container }}
        enablePoison: false
        excludeSdkContentTests: false
        excludeOmniSharpTests: false
        runOnline: false
