### This stage source-builds https://github.com/dotnet/dotnet with varying parameters
### If run in a PR, new changes are applied to a local copy of the VMR, then it is source-built and tested

parameters:
  dependsOn: []
  condition: always()

  # Branch of the VMR to use (to push to for internal builds)
  vmrBranch: $(Build.SourceBranch)

  # True when build is running from dotnet/dotnet directly
  isBuiltFromVmr:

  # Internal builds
  poolInternalAmd64:
    name: NetCore1ESPool-Svc-Internal
    demands: ImageOverride -equals Build.Ubuntu.2204.Amd64
  poolInternalAmd64PR:
    name: NetCore1ESPool-Internal-XL
    demands: ImageOverride -equals Build.Ubuntu.2204.Amd64
  poolInternalArm64:
    name: Docker-Linux-Arm-Internal

  # Public builds / PRs
  poolPublicAmd64:
    name: NetCore-Public-XL
    demands: ImageOverride -equals Build.Ubuntu.2204.Amd64.Open

stages:
- stage: VMR_Source_Build
  displayName: VMR Source-Build
  dependsOn: ${{ parameters.dependsOn }}
  condition: ${{ parameters.condition }}
  variables:
  - ${{ if eq(variables['System.TeamProject'], 'public') }}:
    - name: defaultPoolName
      value: ${{ parameters.poolPublicAmd64.name }}
    - name: defaultPoolDemands
      value: ${{ parameters.poolPublicAmd64.demands }}
  - ${{ if eq(variables['System.TeamProject'], 'internal') }}:
    - ${{ if in(variables['Build.Reason'], 'PullRequest') }}:
      - name: defaultPoolName
        value: ${{ parameters.poolInternalAmd64PR.name }}
      - name: defaultPoolDemands
        value: ${{ parameters.poolInternalAmd64PR.demands }}
    - ${{ else }}:
      - name: defaultPoolName
        value: ${{ parameters.poolInternalAmd64.name }}
      - name: defaultPoolDemands
        value: ${{ parameters.poolInternalAmd64.demands }}

  - ${{ if ne(parameters.vmrBranch, '') }}:
    - name: VmrBranch
      value: ${{ parameters.vmrBranch }}
  - ${{ else }}:
    - name: VmrBranch
      value: ${{ replace(replace(variables['Build.SourceBranch'], 'refs/heads/', ''), 'refs/pull/', '') }}

  jobs:

  # PR and CI legs ------------------------------------

  - template: ../jobs/vmr-build.yml
    parameters:
      # Changing the build name requires updating the referenced name in the source-build-sdk-diff-tests.yml pipeline
      buildName: ${{ format('{0}_Online_MsftSdk', variables.centOSStreamName) }}
      isBuiltFromVmr: ${{ parameters.isBuiltFromVmr }}
      vmrBranch: ${{ variables.VmrBranch }}
      architecture: x64
      pool:
        name: ${{ variables.defaultPoolName }}
        demands: ${{ variables.defaultPoolDemands }}
      container: ${{ variables.centOSStreamContainer }}
      buildFromArchive: false            # ðŸš«
      enablePoison: false                # ðŸš«
      excludeOmniSharpTests: true        # âœ…
      runOnline: true                    # âœ…
      useMonoRuntime: false              # ðŸš«
      withPreviousSDK: false             # ðŸš«

  - template: ../jobs/vmr-build.yml
    parameters:
      # Changing the build name requires updating the referenced name in the source-build-sdk-diff-tests.yml pipeline
      buildName: ${{ format('{0}_Offline_MsftSdk', variables.centOSStreamName) }}
      isBuiltFromVmr: ${{ parameters.isBuiltFromVmr }}
      vmrBranch: ${{ variables.VmrBranch }}
      architecture: x64
      pool:
        name: ${{ variables.defaultPoolName }}
        demands: ${{ variables.defaultPoolDemands }}
      container: ${{ variables.centOSStreamContainer }}
      buildFromArchive: true             # âœ…
      enablePoison: false                # ðŸš«
      excludeOmniSharpTests: true        # âœ…
      runOnline: false                   # ðŸš«
      useMonoRuntime: false              # ðŸš«
      withPreviousSDK: false             # ðŸš«

  - ${{ if ne(variables['Build.Reason'], 'PullRequest') }}:

    # CI - Stage 1 x64 legs ------------------------------------

    - template: ../jobs/vmr-build.yml
      parameters:
        # Changing the build name requires updating the referenced name in the source-build-sdk-diff-tests.yml pipeline
        buildName: ${{ format('{0}_Offline_MsftSdk', variables.alpineName) }}
        isBuiltFromVmr: ${{ parameters.isBuiltFromVmr }}
        vmrBranch: ${{ variables.VmrBranch }}
        architecture: x64
        pool:
          name: ${{ variables.defaultPoolName }}
          demands: ${{ variables.defaultPoolDemands }}
        container: ${{ variables.alpineContainer }}
        buildFromArchive: false            # âœ…
        enablePoison: false                # ðŸš«
        excludeOmniSharpTests: true        # âœ…
        runOnline: false                   # ðŸš«
        useMonoRuntime: false              # ðŸš«
        withPreviousSDK: false             # ðŸš«

    - template: ../jobs/vmr-build.yml
      parameters:
        # Changing the build name requires updating the referenced name in the source-build-sdk-diff-tests.yml pipeline
        buildName: ${{ format('{0}_Online_PreviousSourceBuiltSdk', variables.centOSStreamName) }}
        isBuiltFromVmr: ${{ parameters.isBuiltFromVmr }}
        vmrBranch: ${{ variables.VmrBranch }}
        architecture: x64
        pool:
          name: ${{ variables.defaultPoolName }}
          demands: ${{ variables.defaultPoolDemands }}
        container: ${{ variables.centOSStreamContainer }}
        buildFromArchive: false            # ðŸš«
        enablePoison: false                # ðŸš«
        excludeOmniSharpTests: true        # âœ…
        runOnline: true                    # âœ…
        useMonoRuntime: false              # ðŸš«
        withPreviousSDK: true              # âœ…

    - template: ../jobs/vmr-build.yml
      parameters:
        # Changing the build name requires updating the referenced name in the source-build-sdk-diff-tests.yml pipeline
        buildName: ${{ format('{0}_Offline_PreviousSourceBuiltSdk', variables.centOSStreamName) }}
        isBuiltFromVmr: ${{ parameters.isBuiltFromVmr }}
        vmrBranch: ${{ variables.VmrBranch }}
        architecture: x64
        pool:
          name: ${{ variables.defaultPoolName }}
          demands: ${{ variables.defaultPoolDemands }}
        container: ${{ variables.centOSStreamContainer }}
        buildFromArchive: false            # ðŸš«
        enablePoison: false                # ðŸš«
        excludeOmniSharpTests: true        # âœ…
        runOnline: false                   # ðŸš«
        useMonoRuntime: false              # ðŸš«
        withPreviousSDK: true              # âœ…

    - template: ../jobs/vmr-build.yml
      parameters:
        # Changing the build name requires updating the referenced name in the source-build-sdk-diff-tests.yml pipeline
        buildName: ${{ format('{0}_Mono_Offline_MsftSdk', variables.centOSStreamName) }}
        isBuiltFromVmr: ${{ parameters.isBuiltFromVmr }}
        vmrBranch: ${{ variables.VmrBranch }}
        architecture: x64
        pool:
          name: ${{ variables.defaultPoolName }}
          demands: ${{ variables.defaultPoolDemands }}
        container: ${{ variables.centOSStreamContainer }}
        buildFromArchive: true             # âœ…
        enablePoison: false                # ðŸš«
        excludeOmniSharpTests: true        # âœ…
        runOnline: false                   # ðŸš«
        useMonoRuntime: true               # âœ…
        withPreviousSDK: false             # ðŸš«

    - template: ../jobs/vmr-build.yml
      parameters:
        # Changing the build name requires updating the referenced name in the source-build-sdk-diff-tests.yml pipeline
        buildName: ${{ format('{0}_Offline_MsftSdk', variables.fedoraName) }}
        isBuiltFromVmr: ${{ parameters.isBuiltFromVmr }}
        vmrBranch: ${{ variables.VmrBranch }}
        architecture: x64
        pool:
          name: ${{ variables.defaultPoolName }}
          demands: ${{ variables.defaultPoolDemands }}
        container: ${{ variables.fedoraContainer }}
        buildFromArchive: true             # âœ…
        enablePoison: true                 # âœ…
        excludeOmniSharpTests: false       # ðŸš«
        runOnline: false                   # ðŸš«
        useMonoRuntime: false              # ðŸš«
        withPreviousSDK: false             # ðŸš«

    - template: ../jobs/vmr-build.yml
      parameters:
        # Changing the build name requires updating the referenced name in the source-build-sdk-diff-tests.yml pipeline
        buildName: ${{ format('{0}_Offline_MsftSdk', variables.ubuntuName) }}
        isBuiltFromVmr: ${{ parameters.isBuiltFromVmr }}
        vmrBranch: ${{ variables.VmrBranch }}
        architecture: x64
        pool:
          name: ${{ variables.defaultPoolName }}
          demands: ${{ variables.defaultPoolDemands }}
        container: ${{ variables.ubuntuContainer }}
        buildFromArchive: false            # ðŸš«
        enablePoison: false                # ðŸš«
        excludeOmniSharpTests: false       # ðŸš«
        runOnline: false                   # ðŸš«
        useMonoRuntime: false              # ðŸš«
        withPreviousSDK: false             # ðŸš«

    # CI - Stage 1 arm64 Legs ------------------------------------

    - template: ../jobs/vmr-build.yml
      parameters:
        # Changing the build name requires updating the referenced name in the source-build-sdk-diff-tests.yml pipeline
        buildName: ${{ format('{0}Arm64_Offline_MsftSdk', variables.ubuntuName) }}
        isBuiltFromVmr: ${{ parameters.isBuiltFromVmr }}
        vmrBranch: ${{ variables.VmrBranch }}
        architecture: arm64
        pool: ${{ parameters.poolInternalArm64 }}
        container: ${{ variables.ubuntuArmContainer }}
        buildFromArchive: false            # ðŸš«
        enablePoison: false                # ðŸš«
        excludeOmniSharpTests: false       # ðŸš«
        runOnline: false                   # ðŸš«
        useMonoRuntime: false              # ðŸš«
        withPreviousSDK: false             # ðŸš«

    # CI - Stage 2 x64 Legs ------------------------------------

    - template: ../jobs/vmr-build.yml
      parameters:
        # Changing the build name requires updating the referenced name in the source-build-sdk-diff-tests.yml pipeline
        buildName: ${{ format('{0}_Online_CurrentSourceBuiltSdk', variables.centOSStreamName) }}
        isBuiltFromVmr: ${{ parameters.isBuiltFromVmr }}
        vmrBranch: ${{ variables.VmrBranch }}
        architecture: x64
        pool:
          name: ${{ variables.defaultPoolName }}
          demands: ${{ variables.defaultPoolDemands }}
        container: ${{ variables.centOSStreamContainer }}
        buildFromArchive: false            # ðŸš«
        enablePoison: false                # ðŸš«
        excludeOmniSharpTests: true        # âœ…
        runOnline: false                   # ðŸš«
        useMonoRuntime: false              # ðŸš«
        withPreviousSDK: false             # ðŸš«
        reuseBuildArtifactsFrom: ${{ format('{0}_Online_MsftSdk', variables.centOSStreamName) }}

    - template: ../jobs/vmr-build.yml
      parameters:
        # Changing the build name requires updating the referenced name in the source-build-sdk-diff-tests.yml pipeline
        buildName: ${{ format('{0}_Offline_CurrentSourceBuiltSdk', variables.fedoraName) }}
        isBuiltFromVmr: ${{ parameters.isBuiltFromVmr }}
        vmrBranch: ${{ variables.VmrBranch }}
        architecture: x64
        pool:
          name: ${{ variables.defaultPoolName }}
          demands: ${{ variables.defaultPoolDemands }}
        container: ${{ variables.fedoraContainer }}
        buildFromArchive: false            # ðŸš«
        enablePoison: false                # ðŸš«
        excludeOmniSharpTests: false       # ðŸš«
        runOnline: false                   # ðŸš«
        useMonoRuntime: false              # ðŸš«
        withPreviousSDK: false             # ðŸš«
        reuseBuildArtifactsFrom: ${{ format('{0}_Offline_MsftSdk', variables.fedoraName) }}
